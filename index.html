<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pro Copy Annotations for YouTube videos</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <link rel="license" href="https://www.gnu.org/licenses/gpl-3.0.html" title="GNU GPL v3 or later">

<!-- var API YTB -->
<!-- var API YTB -->  
<!-- Start API YTB -->
<script>

function extract_ids(str) {
  if (str == null) return str;
  return str.replace(/.*?([\?&]v=|[\?&]video_id=|youtu.be\/)([^&\?#\s]+)[\S]*/g, '$2');
}

function get() {
  var video_id = extract_ids(document.getElementById('video_id').value);
  window.open('https://www.youtube.com/annotations_invideo?features=1&legacy=1&video_id='+video_id);
  // legacy=0 appears to only fetch InVideo annotations
}

function gethelp(e) {
  if (e.keyCode == 13) get();
}

function checkxml() {
  var data = document.getElementById('data').value;
  var warn = document.getElementById('ampersand_warning');
  var ret = /&(?!([a-zA-Z][a-zA-Z0-9]*|(#\d+));)/.exec(data);
  if (ret == null) {
    warn.style.visibility = 'hidden';
  }
  else {
    warn.style.visibility = 'visible';
  }
}

function getxml() {
  var data = document.getElementById('data').value;
  if (!data) return alert('You must supply the XML data!');
  data = data.replace(/<\?xml[^>]*\?>/, ''); //https://bugzilla.mozilla.org/show_bug.cgi?id=336551
  data = data.replace(/annotations>/g, 'updatedItems>'); //rename <annotations> to <updatedItems>

  // insert requestHeader and authenticationHeader, if not already present
  var ret = /<authenticationHeader/.exec(data);
  if (ret == null) {
    data = data.replace(/<document.*?>/, '$&<requestHeader video_id="" /><authenticationHeader auth_token="" />');
  }

  // remove InVideo Programming
  data = data.replace(/<annotation [^>]*?id="channel:[\S\s]*?<\/annotation>/g, '');

  return data;
}

function update() {
  var ids = document.getElementById('ids');
  ids.value = extract_ids(ids.value);

  var auth_token = document.getElementById('auth_token').value;
  if (!auth_token) return alert('You must get an auth token before proceeding!');

  var data = getxml();
  if (!data) return;
  var ret = data.match(/<annotation /g);
  var num = (ret != null)?ret.length:0;
  ids = ids.value.split('\n');
  ids.forEach(function(id) {
    var ret = /^([^ #]+)/.exec(id);
    if (ret == null) return;
    var id = ret[1];

    // insert video_id and auth_token into xml
    data = data.replace(/<requestHeader(.*?)video_id=".*?"(.*?)>/, '<requestHeader$1video_id="'+id+'"$2>');
    data = data.replace(/<authenticationHeader(.*?)auth_token=".*?"(.*?)>/, '<authenticationHeader$1auth_token="'+auth_token+'"$2>');
    console.log(data);

    var xhr = new XMLHttpRequest();
    xhr.withCredentials = true;
    xhr.open('POST', 'https://www.youtube.com/annotations_auth/update2', true);
    xhr.send(data);

    var link = document.createElement('a');
    link.href = 'https://www.youtube.com/my_videos_annotate?v='+id;
    link.target = '_blank';
    link.appendChild(document.createTextNode(id));
    log('Copying '+num+' annotations to ', link);
  });
}

function publish() {
  var ids = document.getElementById('ids');
  ids.value = extract_ids(ids.value);

  var auth_token = document.getElementById('auth_token').value;
  if (!auth_token) return alert('You must get an auth token before proceeding!');

  ids = ids.value.split('\n');
  ids.forEach(function(id) {
    var ret = /^([^ #]+)/.exec(id);
    if (ret == null) return;
    var id = ret[1];

    // publish
    var pubdata = '<document><requestHeader video_id="'+id+'" /><authenticationHeader auth_token="'+auth_token+'" /></document>';
    console.log(pubdata);

    var xhr = new XMLHttpRequest();
    xhr.withCredentials = true;
    xhr.open('POST', 'https://www.youtube.com/annotations_auth/publish2', true);
    xhr.send(pubdata);

    var link = document.createElement('a');
    link.href = 'https://www.youtube.com/watch?v='+id;
    link.target = '_blank';
    link.appendChild(document.createTextNode(id));
    log('Publishing ', link);
  });
}

function clearvideo() {
  var auth_token = document.getElementById('auth_token').value;
  if (!auth_token) return alert('You must get an auth token before proceeding!');

  var data = getxml();
  if (!data) return;
  var id = extract_ids(document.getElementById('video_id').value);
  if (!id) id = extract_ids(prompt('Input video id or url:'));
  if (!id) return;

  if (!confirm('Are you sure you want to delete all annotations from video with id '+id+'?')) return;

  // extract annotation ids
  var deldata = '<document><requestHeader video_id="'+id+'" /><authenticationHeader auth_token="'+auth_token+'" /><deletedItems>';
  var regex = /<annotation( author=".*?")?( id=".*?")/ig;
  var num = 0;
  while ((ret=regex.exec(data)) != null) {
    num++;
    if (!ret[1]) ret[1] = ' author=""'; // author is only included when fetching annotations from old videos and using the annotation editor (but author must be present when deleting, so guessing empty author, which won't work if the annotation is super old; in this case, fetch the annotations via the annotation editor by using the greasemonkey script)
    deldata += '<deletedItem'+ret[1]+ret[2]+' />';
  }
  deldata += '</deletedItems></document>';
  console.log(deldata);

  var xhr = new XMLHttpRequest();
  xhr.withCredentials = true;
  xhr.open('POST', 'https://www.youtube.com/annotations_auth/update2', true);
  xhr.send(deldata);

  var link = document.createElement('a');
  link.href = 'https://www.youtube.com/my_videos_annotate?v='+id;
  link.target = '_blank';
  link.appendChild(document.createTextNode(id));
  log('Deleting '+num+' annotations from ', link);

  // publish in a moment
  setTimeout(function() {
    var pubdata = '<document><requestHeader video_id="'+id+'" /><authenticationHeader auth_token="'+auth_token+'" /></document>';
    console.log(pubdata);

    var xhr = new XMLHttpRequest();
    xhr.withCredentials = true;
    xhr.open('POST', 'https://www.youtube.com/annotations_auth/publish2', true);
    xhr.send(pubdata);

    var link = document.createElement('a');
    link.href = 'https://www.youtube.com/watch?v='+id;
    link.target = '_blank';
    link.appendChild(document.createTextNode(id));
    log('Publishing ', link);
  }, 1000);
}

function log(s, e) {
  var log = document.getElementById('log');
  var li = document.createElement('li');
  li.appendChild(document.createTextNode(s));
  if (e) li.appendChild(e);
  li.appendChild(document.createTextNode('.'));
  log.appendChild(li);
}

</script>
<!-- End API YTB -->
<style type="text/css">
#ampersand_warning {
  visibility: hidden;
  font-size: large;
  color: red;
  font-weight: bold;
}
</style>

</head>
<body>
  <div class="container">
  <header>
    <hgroup>
      <h1 itemprop="name">Pro Copy Annotations for YouTube videos </h1>
    </hgroup>
  </header>
    <noscript>
      <div class="alert alert-danger text-center"><strong>Bạn cần bật JavaScript để sử dụng chức năng trong trang web này!</strong></div>
    </noscript>

    <p>Trang này sẽ hướng dẫn các bạn làm thế nào để copy các chú thích mẫu sang hàng loạt các video khác của bạn. Cách này cũng sẽ giúp bản sửa chú thích của bạn theo theo ý muốn tương tự như của chú thích mẫu. Tất cả sẽ được thực hiện với "Client-side JavaScript".</p>
	<p>(This page describes how to copy YouTube annotations across videos. It essentially helps you liberate your annotations data, modify it at will, and upload it again to multiple videos. Everything is done with client-side JavaScript.)</p>
    <p><strong>Ứng dụng được test trên Firefox và Chrome. (This tool only tested in Firefox and Chrome.)</strong></p>

    <h3>Update:</h3>
    <p><strong>2015-03-09:</strong> Update lại giao diện. Sửa một vài lỗi trên Chrome.(New design. And it appears this script also works in Chrome now)</p>

    <h2 id="step1">Step 1: Get annotation</h2>

    <div class="input-group col-sm-9">
      <input class="form-control" type="text" id="video_id" placeholder="Paste video id or url here, then click -->" onkeydown="gethelp(event);" monospace>
      <span class="input-group-btn">
        <button class="btn btn-primary" onclick="get();">Get annotations</button>
      </span>
    </div>

    <p>Mỗi lần bạn get XML, chuột phải, chọn <em>view page source</em>, ctrl+A, và copy mọi thứ. (Once you see the XML, right click, <em>view page source</em>, and copy everything.)</p>
    <p><strong>Note:</strong> All this input box does is redirect you to YouTube. You don't need to use this box if you have hundreds of videos, you can simply go directly to the youtube.com url.</p>


    <h2 id="step2">Step 2: Paste XML</h2>

    <p>Paste đoạn XML mà bạn đã copy được ở trên. (Put the XML into this box.)</p>

    <textarea class="form-control" id="data" rows="10" placeholder="Paste le big XML data here...  &gt;&lt;(((('&gt;" onkeyup="checkxml();" monospace></textarea><br/>

    <p><strong>Note:</strong> If you have ampersands (<strong>&amp;</strong>) in a text or if you use urls, make sure the ampersands are escaped! This means all <strong>&amp;</strong> should be escaped like <strong>&amp;amp;</strong>. If you copy using <em>view page source</em>, then this should happen automatically!</p>

    <p id="ampersand_warning">Warning: Your XML code contains unescaped ampersands!</p>


    <h2 id="step3">Step 3: Modify XML <small>(Optional)</small></h2>

    <p>Bạn có thể thay đổi mọi thứ về chú thích của bạn mà các Developer của YTB không nghĩ tới. Dưới là ví dụ: (This is your chance to do things the YouTube developers did not think of. A few examples:)</p>
    <ul>
      <li>Cho các chứ thích kéo dài cả video, thay đổi thời gian kết thúc như sau: (If you want the annotations to last the whole video, change the end time to something like) <tt>t="1:00:00.0"</tt>.</li>
      <li>Thay đổi độ rộng, cao của chú thích vượt qua giới hạn mà bạn có thể sửa trong phần chỉnh sửa chú thích của YTB. (You can change the width and height of the annotations to sizes that the normal editor will not allow.)</li>
    </ul>


    <h2 id="step4">Step 4: Get auth_token</h2>

    <p>Bạn cần phải có một auth_token cho tool này khả để cập nhật các video của bạn, và đặt nó trong hộp auth_token dưới đây. Các auth_token có thời gian hết hạn tôi không chắc chắn bao lâu, nếu bạn đã lấy auth_token một lúc rồi mới thực hiện copy chú thích mà không được thì hãy lấy một auth_token mới. <br>(You need to get an auth_token to give this script the ability to update your videos, and put it in the auth_token box below. The auth_token is time dependent and will eventually stop working - I am not sure how long.)</p>

    <p>Để lấy mã auth_token bạn có thể dễ dàng view source trang sửa chú thích của YTB để lấy, hoặc có thể sử dụng thêm script bên dưới để lấy. <br>(To get the auth_token, you can either search for it in the source code in the YouTube annotations editor, or you can install a userscript I made that simplifies getting the auth_token. To use it in Firefox, you need Greasemonkey, for Chrome you need Tampermonkey.)</p>

    <p class="buttons">
      <a href="https://addons.mozilla.org/en-US/firefox/addon/greasemonkey/" target="_blank"><button class="btn btn-default">Firefox: Install Greasemonkey</button></a>
      <a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo" target="_blank"><button class="btn btn-default">Chrome: Install Tampermonkey</button></a>
      <a href="https://github.com/nightrelax/youtube-pro-copy-annotations/raw/master/youtube_auth_token.user.js" target="_self"><button class="btn btn-default">Install the userscript (after instal Gmonkey or Tmonkey)</button></a>
    </p>

    <p>Mỗi lần bạn vào trang sửa chú thích của YTB, một ô auth_token sẽ xuất hiện ở góc bên phải phía dưới cùng của trang. (Once you have the userscript, a text field will appear in the lower right of the YouTube annotations editor with an auth_token.)</p>

    <p>Copy mã auth_token vào ô dưới. (Put the auth_token in this text field:)</p>

    <p><input class="form-control" type="text" id="auth_token" placeholder="Paste your auth_token here" monospace></p>


    <h2 id="step5">Step 5: Delete! <small>(Optional)</small></h2>

    <p>Mục này bạn có thể xóa chú thích của video mà bạn muốn, nó chỉ tác dụng trên video mà bạn dùng để lấy mã auth_token. (At this stage, you can delete the annotation if you want. This will only delete them from the video you fetched them from. The deletion will be published automatically.)</p>

    <p><button class="btn btn-danger" onclick="clearvideo();">Delete annotations</button></p>


    <h2 id="step6">Step 6: Destination videos</h2>

    <p>Bạn hãy copy một danh sách của các video cần copy chú thích vào bên dưới. Note: Vào My_video của YTB ở dưới cùng bạn sẽ thấy danh sách id của trang đó - nếu bạn đã cài Gmonkey hoặc Tmonkey (Put a list of destination video ids or urls in this box.)</p>

    <p><textarea class="form-control" id="ids" rows="10" placeholder="List of video ids or urls. Separate with newlines. Everything that comes after a space is considered a comment." monospace></textarea></p>


    <h2 id="step7">Step 7: Copy!</h2>

    <p>Hãy ấn Copy rồi ấn Publish chú thích. (When you click the button below, the annotations will be copied. They are not published automatically.)</p>

    <p class="buttons">
      <button class="btn btn-primary" onclick="update();">1.Copy annotations</button>
      <button class="btn btn-default" onclick="publish();">2.Publish annotations</button>
    </p>

    <p>You should first verify that the annotations were copied correctly by looking at the draft version with the YouTube annotation editor.</p>
    <p>If it didn't work and the annotations weren't copied, use <a href="https://addons.mozilla.org/en-US/firefox/addon/firebug/" target="_blank">Firebug</a> and check the Network tab and see if the result was anything other than "200 Ok".</p>
    <p>Note that "<a target="_blank" href="https://support.google.com/youtube/answer/6147757">InVideo Programming</a>" annotations are automatically removed since they otherwise will cause the copy to fail. You can try to remove them manually if you encounter problems (they have ids that start with <code>channel:</code>).</p>


    <h2 id="log">Log</h2>

    <p>The actions you perform above will be printed here.</p>

    <ul id="log"></ul>

  </div>

</body>
</html>
